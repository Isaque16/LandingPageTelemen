<template>
  <header class="flex flex-col p-5 w-full h-full" id="cabecalho">
    <nuxt-link to="/">
      <div class="p-2">
        <h1 class="text-4xl md:text-6xl text-center p-2 font-IBM font-bold">
          TELEMENSAGEM <br />
          ROSA DE SAROM
        </h1>
        <p class="text-center text-lg font-playWrite">
          游눏 Palavras que viram presentes 游꾸
        </p>
      </div>
    </nuxt-link>
  </header>
  <hr />

  <main class="p-5 w-full">
    <section class="flex flex-col my-10">
      <h2
        class="text-center text-4xl my-10 bg-transparent p-3 rounded-3xl font-bold"
      >
        AGENDAMENTO
      </h2>
      <form
        id="form"
        class="flex flex-col gap-2 w-full"
        action="/submit"
        method="post"
      >
        <h2 class="bg-red-600 p-2 rounded-xl w-fit text-2xl font-bold">
          Modelo de mensagem
        </h2>
        <div class="flex flex-row-reverse md:flex-row gap-4 text-xl">
          <div
            class="bg-red-600 p-2 w-fit flex flex-row gap-2 rounded-b-xl rounded-tr-xl"
          >
            <label class="text-2xl" for="Ao Vivo"> R$180 | Ao Vivo </label>
            <input
              type="radio"
              name="modelo"
              value="Ao Vivo"
              v-model="form.modelo"
              @change="updateForm"
            />
          </div>
          <div
            class="bg-red-600 p-2 w-fit flex flex-row gap-2 rounded-b-xl rounded-tr-xl"
          >
            <label class="text-2xl" for="Por Telefone">
              R$20 | Telefone <br />
            </label>
            <input
              type="radio"
              name="modelo"
              value="Por Telefone"
              v-model="form.modelo"
              @change="updateForm"
            />
          </div>
        </div>

        <div class="flex flex-col gap-5">
          <input-component
            forLabel="nome"
            inputTitle="Quem envia"
            inputType="text"
            v-model="form.nome"
            placeholder="Nome(s)"
            autocomplete="name"
            info-message="Preencha com o nome do remetente, que pode ser seu ou de v치rias pessoas."
            error-message="Informe pelo menos o primeiro nome de quem est치 enviando!"
          ></input-component>

          <input-component
            forLabel="para"
            inputTitle="Para quem"
            inputType="text"
            v-model="form.para"
            placeholder="Nome da homenagiada(o)"
            info-message="Preencha com o nome da pessoa a ser homenageada."
            error-message="Informe pelo menos o primeiro nome da pessoa que vai receber"
          ></input-component>

          <input-component
            forLabel="hora"
            inputTitle="Hor치rio da mensagem"
            inputType="time"
            v-model="form.hora"
            info-message="Preencha este campo com a hora em que a mensagem deve ser enviada"
            error-message="칄 preciso informar o hor치rio de envio da mensagem"
          ></input-component>

          <input-component
            forLabel="data"
            inputTitle="Data de envio"
            inputType="date"
            v-model="form.data"
            info-message="Preencha a data de envio da mensagem e agende com anteced칡ncia."
            error-message="칄 preciso informar a data de envio da mensagem"
          ></input-component>

          <div class="flex flex-col p-2">
            <div>
              <label
                class="bg-red-600 p-2 rounded-t-xl w-fit text-2xl font-bold text-center"
              >
                Ocasi칚o da mensagem
              </label>
            </div>
            <div
              class="bg-red-600 p-2 w-full md:w-1/2 rounded-b-xl rounded-tr-xl"
            >
              <select
                class="px-2 py-1 text-black text-xl rounded-xl w-full md:w-50"
                v-model="form.ocasiao"
              >
                <optgroup label="Anivers치rio">
                  <option value="Anivers치rio de M칚e">Anivers치rio de M칚e</option>
                  <option value="Anivers치rio de Pai">Anivers치rio de Pai</option>
                  <option value="Anivers치rio de Irm칚">
                    Anivers치rio de Irm칚
                  </option>
                  <option value="Anivers치rio de Irm칚o">
                    Anivers치rio de Irm칚o
                  </option>
                  <option value="Anivers치rio de Filha">
                    Anivers치rio de Filha
                  </option>
                  <option value="Anivers치rio de Filho">
                    Anivers치rio de Filho
                  </option>
                  <option value="Anivers치rio de Namorda">
                    Anivers치rio de Namorada
                  </option>
                  <option value="Anivers치rio de Namorado">
                    Anivers치rio de Namorado
                  </option>
                  <option value="Anivers치rio de Noiva">
                    Anivers치rio de Noiva
                  </option>
                  <option value="Anivers치rio de Noivo">
                    Anivers치rio de Noivo
                  </option>
                  <option value="Anivers치rio de Marido">
                    Anivers치rio de Marido
                  </option>
                  <option value="Anivers치rio de Esposa">
                    Anivers치rio de Esposa
                  </option>
                  <option value="Anivers치rio de Sogra">
                    Anivers치rio de Sogra
                  </option>
                  <option value="Anivers치rio de Sogro">
                    Anivers치rio de Sogro
                  </option>
                  <option value="Anivers치rio de Cunhada">
                    Anivers치rio de Cunhada
                  </option>
                  <option value="Anivers치rio de Cunhado">
                    Anivers치rio de Cunhado
                  </option>
                  <option value="Anivers치rio de Amiga">
                    Anivers치rio de Amiga
                  </option>
                  <option value="Anivers치rio de Amigo">
                    Anivers치rio de Amigo
                  </option>
                </optgroup>
                <optgroup label="Datas comemorativas">
                  <option value="Dia das M칚es">Dia das M칚es</option>
                  <option value="Dia dos Pais">Dia dos Pais</option>
                  <option value="Dia dos Namorados">Dia dos Namorados</option>
                  <option value="Dia da Mulher">Dia da Mulher</option>
                  <option value="Natal">Natal</option>
                  <option value="Ano Novo">Ano Novo</option>
                </optgroup>
              </select>
            </div>
          </div>

          <input-component
            forLabel="contato"
            inputTitle="Telefone para contato"
            inputType="text"
            v-model="form.contato"
            placeholder="ex: 68 12345678"
            info-message="Digite seu n칰mero de telefone para mantermos contato"
            error-message="Precisamos manter contato! Nos informe seu n칰mero"
          ></input-component>

          <input-component
            v-if="form.modelo == 'Por Telefone'"
            forLabel="destinatariotel"
            inputTitle="N칰mero do destinat치rio"
            inputType="text"
            v-model="form.destinatariotel"
            placeholder="ex: 68 12345678"
            info-message="Digite o n칰mero de telefone do homenagiada(o)"
            error-message="Precisamos do contato para o envio da mensagem"
          ></input-component>

          <input-component
            v-if="form.modelo == 'Ao Vivo'"
            forLabel="musica"
            inputTitle="Nome da m칰sica"
            inputType="text"
            v-model="form.musica"
            placeholder="ex: Esse cara sou eu - Roberto Carlos"
            info-message="Escreva o nome da m칰sica preferida do destinat치rio, pois ela tocar치 na chegada ao local."
            error-message="A escolha de uma m칰sica de sua preferencia 칠 necess치rio"
          ></input-component>

          <div class="flex flex-col p-2">
            <div
              class="bg-red-600 p-4 w-full md:w-1/2 rounded-b-xl rounded-tr-xl"
            >
              <nuxt-link
                :to="`/mensagens/${form.ocasiao}`"
                class="p-2 text-2xl font-bold hover:cursor-pointer"
                >Escolher mensagem: {{ form.mensagem }}</nuxt-link
              >
            </div>
          </div>

          <input-component
            v-if="form.modelo == 'Ao Vivo'"
            forLabel="endereco"
            inputTitle="Endere칞o da comemora칞칚o"
            inputType="text"
            v-model="form.endereco"
            placeholder="ex: R. Cumaru, Portal da Amaz칪nia, Rio Branco, Acre"
            info-message="Por 칰ltimo, insira o endere칞o do local da comemora칞칚o."
            error-message="Por favor, digite o endere칞o da comemora칞칚o corretamente"
          ></input-component>

          <div class="flex flex-col p-2 rounded-xl text-center gap-2">
            <button
              @click.prevent="dialogScreen?.showModal()"
              :disabled="isThereEmptyFields"
              :class="`${toggleButtonClass} p-2 rounded-xl text-2xl font-workSans w-full md:w-1/2 font-bold`"
            >
              {{ agendarBtn }}
            </button>
          </div>
        </div>
      </form>

      <dialog ref="dialogScreen" class="rounded-lg">
        <confirmation-screen
          @closeDialog="dialogScreen?.close()"
          @agendarBtnBadRequest="agendarBtn = 'Hor치rio indispon칤vel nessa data'"
          :prop-modelo="form.modelo"
          :prop-nome="form.nome"
          :prop-para="form.para"
          :prop-hora="form.hora"
          :prop-data="form.data.split('-').reverse().join('/')"
          :prop-ocasiao="form.ocasiao"
          :prop-contato="form.contato"
          :prop-endereco="form.endereco"
          :prop-musica="form.musica"
          :prop-destinatariotel="form.destinatariotel"
          :prop-mensagem="form.mensagem"
        ></confirmation-screen>
      </dialog>
    </section>
  </main>
</template>

<script lang="ts" setup>
// Verifica se j치 houve agendamento ou n칚o ao acessar a p치gina
onBeforeMount(() => {
  const isAgendadoActive = localStorage.getItem("agendado");
  if (isAgendadoActive === null)
    return localStorage.setItem("agendado", JSON.stringify(false));
  else {
    const isAgendado = computed(() => JSON.parse(isAgendadoActive));
    if (isAgendado.value) {
      form.isAgendado = isAgendado.value;
      useRouter().replace("/agendado");
    }
  }
});

// Armazenando vari치veis globais com Pinia
import { userFormStore } from "~/store/userFormStore";
const form = userFormStore().formData;

const modeloParams = useRoute().query.modelo; // Muda os inputs mostrados no form de acordo com o radio
// Verifica a query do header quando a p치gina 칠 carregada
onMounted(() => {
  if (modeloParams === "Ao Vivo" || modeloParams === "Ao+Vivo")
    form.modelo = "Ao Vivo";
  else if (modeloParams === "Por Telefone" || modeloParams === "Por+Telefone")
    form.modelo = "Por Telefone";
});

const updateForm = () => form.modelo; // Altera o valor do formul치rio quando alterado

const agendarBtn = ref("AGENDAR");
const dialogScreen = ref<HTMLDialogElement | null>();

// L칩gica da verifica칞칚o do preenchimento dos inputs
const formDefaultSet = computed(
  () =>
    !form.nome ||
    !form.para ||
    !form.hora ||
    !form.data ||
    !form.ocasiao ||
    !form.contato || 
    !form.mensagem
);
const aovivoSet = computed(
  () => form.modelo === "Ao Vivo" && (!form.musica || !form.endereco)
);
const portelefoneSet = computed(
  () =>
    form.modelo === "Por Telefone" && (!form.destinatariotel)
);
// L칩gica de verifica칞칚o: ser치 falso se qualquer um deles for falso
const isThereEmptyFields = computed(
  () => formDefaultSet.value || aovivoSet.value || portelefoneSet.value
);
// Verifica se h치 algum campo n칚o preenchido
const toggleButtonClass = computed(() => {
  if (isThereEmptyFields.value)
    return "bg-gray-500 opacity-70 cursor-not-allowed";
  return "bg-red-700 hover:bg-red-600";
});

watch(agendarBtn, (agendarBtnValue: string) => {
  if (agendarBtnValue != "AGENDAR")
    setTimeout(() => (agendarBtn.value = "AGENDAR"), 5000);
});
</script>
