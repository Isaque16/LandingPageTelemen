<template>
  <header class="flex flex-col p-5 w-full h-full" id="cabecalho">
    <nuxt-link to="/">
      <div class="p-2">
        <h1 class="text-4xl md:text-6xl text-center p-2 font-IBM font-bold">
          TELEMENSAGEM <br />
          ROSA DE SAROM
        </h1>
        <p class="text-center text-lg font-playWrite">
          游눏 Palavras que viram presentes 游꾸
        </p>
      </div>
    </nuxt-link>
  </header>
  <hr />

  <main class="p-5 w-full">
    <section class="flex flex-col my-10">
      <h2
        class="text-center text-4xl my-10 bg-transparent p-3 rounded-3xl font-bold"
      >
        AGENDAMENTO
      </h2>
      <form
        id="form"
        class="flex flex-col gap-2 w-full"
        action="/submit"
        method="post"
        v-if="!isAgendado"
      >
        <h2 class="bg-red-600 p-2 rounded-xl w-fit text-2xl font-bold">
          Modelo de mensagem
        </h2>
        <div class="flex flex-row-reverse md:flex-row gap-4 text-xl">
          <div
            class="bg-red-600 p-2 w-fit flex flex-row gap-2 rounded-b-xl rounded-tr-xl"
          >
            <label class="text-2xl" for="Ao Vivo"> R$180 | Ao Vivo </label>
            <input
              type="radio"
              name="modelo"
              value="Ao Vivo"
              v-model="form.radioValue"
              @change="updateForm"
            />
          </div>
          <div
            class="bg-red-600 p-2 w-fit flex flex-row gap-2 rounded-b-xl rounded-tr-xl"
          >
            <label class="text-2xl" for="Por Telefone">
              R$20 | Telefone <br />
            </label>
            <input
              type="radio"
              name="modelo"
              value="Por Telefone"
              v-model="form.radioValue"
              @change="updateForm"
            />
          </div>
        </div>

        <div class="flex flex-col gap-5">
          <input-component
            forLabel="nome"
            inputTitle="Quem envia"
            inputType="text"
            v-model="form.nome"
            placeholder="Nome(s)"
            autocomplete="name"
            info-message="Neste campo voc칡 deve preencher com o nome de quem est치 enviando, podendo ser somente o seu ou de v치rias pessoas em conjunto"
            error-message="Informe pelo menos o primeiro nome de quem est치 enviando!"
          ></input-component>

          <input-component
            forLabel="para"
            inputTitle="Para quem"
            inputType="text"
            v-model="form.para"
            placeholder="Nome da homenagiada(o)"
            info-message="Aqui, voc칡 deve preencher com o nome da pessoa que ser치 homenagiada(o)"
            error-message="Informe pelo menos o primeiro nome da pessoa que vai receber"
          ></input-component>

          <input-component
            forLabel="hora"
            inputTitle="Hor치rio da mensagem"
            inputType="time"
            v-model="form.hora"
            info-message="Agora voc칡 deve preencher este campo com a hor치 que a mensagem deve ocorrer, podendo estar ou n칚o dispon칤vel no dia"
            error-message="칄 preciso informar o hor치rio de envio da mensagem"
          ></input-component>

          <input-component
            forLabel="data"
            inputTitle="Data de envio"
            inputType="date"
            v-model="form.data"
            info-message="Da mesma forma a data de envio da mensagem. Por favor, sempre agende com antecedencia"
            error-message="칄 preciso informar a data de envio da mensagem"
          ></input-component>

          <div class="flex flex-col p-2">
            <div>
              <label
                class="bg-red-600 p-2 rounded-t-xl w-fit text-2xl font-bold text-center"
              >
                Ocasi칚o da mensagem
              </label>
            </div>
            <div
              class="bg-red-600 p-2 w-full md:w-1/2 rounded-b-xl rounded-tr-xl"
            >
              <select
                class="px-2 py-1 text-black text-xl rounded-xl w-full md:w-50"
                v-model="form.ocasiao"
              >
                <optgroup label="Anivers치rio">
                  <option value="Anivers치rio de M칚e">
                    Anivers치rio de M칚e
                  </option>
                  <option value="Anivers치rio de Pai">
                    Anivers치rio de Pai
                  </option>
                  <option value="Anivers치rio de Irm칚">
                    Anivers치rio de Irm칚
                  </option>
                  <option value="Anivers치rio de Irm칚o">
                    Anivers치rio de Irm칚o
                  </option>
                  <option value="Anivers치rio de Filha">
                    Anivers치rio de Filha
                  </option>
                  <option value="Anivers치rio de Filho">
                    Anivers치rio de Filho
                  </option>
                  <option value="Anivers치rio de Namorda">
                    Anivers치rio de Namorada
                  </option>
                  <option value="Anivers치rio de Namorado">
                    Anivers치rio de Namorado
                  </option>
                  <option value="Anivers치rio de Noiva">
                    Anivers치rio de Noiva
                  </option>
                  <option value="Anivers치rio de Noivo">
                    Anivers치rio de Noivo
                  </option>
                  <option value="Anivers치rio de Marido">
                    Anivers치rio de Marido
                  </option>
                  <option value="Anivers치rio de Esposa">
                    Anivers치rio de Esposa
                  </option>
                  <option value="Anivers치rio de Sogra">
                    Anivers치rio de Sogra
                  </option>
                  <option value="Anivers치rio de Sogro">
                    Anivers치rio de Sogro
                  </option>
                  <option value="Anivers치rio de Cunhada">
                    Anivers치rio de Cunhada
                  </option>
                  <option value="Anivers치rio de Cunhado">
                    Anivers치rio de Cunhado
                  </option>
                  <option value="Anivers치rio de Amiga">
                    Anivers치rio de Amiga
                  </option>
                  <option value="Anivers치rio de Amigo">
                    Anivers치rio de Amigo
                  </option>
                </optgroup>
                <optgroup label="Datas comemorativas">
                  <option value="Dia das M칚es">Dia das M칚es</option>
                  <option value="Dia dos Pais">Dia dos Pais</option>
                  <option value="Dia dos Namorados">Dia dos Namorados</option>
                  <option value="Dia da Mulher">Dia da Mulher</option>
                  <option value="Natal">Natal</option>
                  <option value="Ano Novo">Ano Novo</option>
                </optgroup>
              </select>
            </div>
          </div>

          <input-component
            forLabel="contato"
            inputTitle="Telefone para contato"
            inputType="text"
            v-model="form.contato"
            placeholder="ex: 68 12345678"
            info-message="Digite aqui o seu n칰mero de telefone para mantermos contato"
            error-message="Precisamos manter contato! Nos informe seu n칰mero"
          ></input-component>

          <input-component
            v-if="form.radioValue == 'Por Telefone'"
            forLabel="destinatariotel"
            inputTitle="N칰mero do destinat치rio"
            inputType="text"
            v-model="form.destinatariotel"
            placeholder="ex: 68 12345678"
            info-message="Digite aqui o n칰mero de telefone da pessoa que vai receber a mensagem"
            error-message="Precisamos do contato para o envio da mensagem"
          ></input-component>

          <div class="flex flex-col p-2" v-if="form.radioValue == 'Por Telefone'">
            <div
              class="bg-red-600 p-4 w-full md:w-1/2 rounded-b-xl rounded-tr-xl"
            >
              <nuxt-link
                :to="`/mensagens/${form.ocasiao}`"
                class="p-2 text-2xl font-bold hover:cursor-pointer"
                >Escolher mensagem: {{ form.mensagem }}</nuxt-link
              >
            </div>
          </div>

          <input-component
            v-if="form.radioValue == 'Ao Vivo'"
            forLabel="musica"
            inputTitle="Nome da m칰sica"
            inputType="text"
            v-model="form.musica"
            placeholder="ex: Esse cara sou eu - Roberto Carlos"
            info-message="Escreva o nome da m칰sica da preferencia de quem vai receber a mensagem, pois essa chegar치 tocando na chegada ao local"
            error-message="A escolha de uma m칰sica de sua preferencia 칠 necess치rio"
          ></input-component>

          <input-component
            v-if="form.radioValue == 'Ao Vivo'"
            forLabel="endereco"
            inputTitle="Endere칞o da comemora칞칚o"
            inputType="text"
            v-model="form.endereco"
            placeholder="ex: R. Cumaru, Portal da Amaz칪nia, Rio Branco, Acre"
            info-message="Por 칰ltimo, escreva ou cole neste campo o endere칞o do local onde ocorrer치 a comemora칞칚o da data em quest칚o"
            error-message="Por favor, digite o endere칞o/local da comemora칞칚o corretamente"
          ></input-component>

          <div class="flex flex-col p-2 rounded-xl text-center gap-2">
            <button
              @click.prevent="sendInputValues()"
              class="p-2 bg-red-700 hover:bg-red-600 rounded-xl cursor-pointer text-2xl font-workSans w-full md:w-1/2 font-bold"
            >
              {{ agendarBtn }}
            </button>
          </div>
        </div>
      </form>

      <dialog ref="dialogScreen" class="rounded-lg">
        <confirmation-screen
          @closeDialog="closeDialog"
          @agendadoResponse="agendadoResponse"
          @agendarBtnBadRequest="agendarBadRequest"
          :prop-input-radio="form.radioValue"
          :prop-nome="form.nome"
          :prop-para="form.para"
          :prop-hora="form.hora"
          :prop-data="form.data.split('-').reverse().join('/')"
          :prop-ocasiao="form.ocasiao"
          :prop-contato="form.contato"
          :prop-endereco="form.endereco"
          :prop-musica="form.musica"
          :prop-destinatariotel="form.destinatariotel"
          :prop-mensagem="form.mensagem"
        ></confirmation-screen>
      </dialog>

      <confirmed-screen
        v-if="isAgendado"
        @agendamentoAtivo="agendamentoAtivo"
        :prop-sent-time="form.hora"
        :prop-sent-date="form.data"
      ></confirmed-screen>
    </section>
  </main>
</template>

<script setup lang="ts">
import { useRoute } from "vue-router";
import { onMounted, ref, watch } from "vue";
import { useFormStore } from "~/store/userFormStore";

// Utilizando Pinia
const formStore = useFormStore();
const form = formStore.formData;

// Muda os inputs mostrados no form de acordo com o radio
const route = useRoute();
const modeloParams = route.query.modelo;

// Executa a l칩gica quando o componente 칠 montado
onMounted(() => {
  if (modeloParams === 'Ao Vivo' || modeloParams === 'Ao+Vivo') form.radioValue = "Ao Vivo";
  else if (modeloParams === 'Por Telefone' || modeloParams === 'Por+Telefone') form.radioValue = "Por Telefone";
});

const updateForm = () => form.radioValue; // Altera o valor do formul치rio quando alterado

const agendarBtn = ref("AGENDAR");
const dialogScreen = ref<HTMLDialogElement | null>();

// Verifica o preenchimento dos inputs
function sendInputValues() {
  const formDefaultSet: boolean =
    !form.nome ||
    !form.para ||
    !form.hora ||
    !form.data ||
    !form.ocasiao ||
    !form.contato;
  const aovivoSet: boolean =
    form.radioValue === "Ao Vivo" && 
    (!form.musica || !form.endereco);
  const portelefoneSet: boolean =
    form.radioValue === "Por Telefone" &&
    (!form.destinatariotel || !form.mensagem);

  // Verifica se h치 algum campo obrigat칩rio n칚o preenchido
  if (formDefaultSet || aovivoSet || portelefoneSet) {
    agendarBtn.value = "Verifique os campos vazios!";
    setTimeout(() => (agendarBtn.value = "AGENDAR"), 5000);
  } else dialogScreen.value?.showModal();
}

// Respostas do agendamento
const closeDialog = () => dialogScreen.value?.close();
const agendarBadRequest = () => {
  closeDialog();
  agendarBtn.value = "Houve um erro ao enviar os dados";
  setTimeout(() => (agendarBtn.value = "AGENDAR"), 5000);
};

// Define o estado do formul치rio como agendado ou n칚o
const isAgendado = ref<boolean>(false); // Status de agendamento
const agendamentoAtivo = (isAtivo: boolean) => (isAgendado.value = isAtivo);
const agendadoResponse = (res: boolean) => (isAgendado.value = res);

// Verifica se j치 houve agendamento ou n칚o
onMounted(() => {
  const isAgendadoActive = localStorage.getItem("agendado");
  if (isAgendadoActive !== null) isAgendado.value = isAgendadoActive == "true";
});

watch(isAgendado, (newAgendado: boolean) =>
  localStorage.setItem("agendado", String(newAgendado)),
); // Observa o valor do isAgendado
</script>
